require 'rake/clean'

CLEAN.include('libyaml.rb', '*~', 'a.out')

task :default => :test

desc "run a small test program against the generated yaml2.rb"
task :test => 'libyaml.rb' do
  sh "maglev-ruby main.rb"
end

desc "run libyaml.rb.ffi through the struct generator"
file 'libyaml.rb' => 'libyaml.rb.ffi' do |t|
  require 'platform'

  require '/Users/pmclain/external/ffi/lib/ffi/tools/struct_generator'
  require '/Users/pmclain/external/ffi/lib/ffi/tools/const_generator'
  require '/Users/pmclain/external/ffi/lib/ffi/tools/generator'

  puts "Generating #{t.name}..." # if Rake.application.options.trace
  FFI::Generator.new 'libyaml.rb.ffi', 'libyaml.rb', {:cflags => '-m64'}
end
