# Notes on MagLev and Rails3

## Pre-Requisites

You'll need to install some gems:

  $ maglev-gem install i18n rack-mount rack arel erubis

Then you can just do "rake" to run the tests.
To run the rails app, do "rake app"

## Rails 3 Source

The rails3 source is in the rails subdirectory (a git submodule).  It is
tracking /export/smalltalk/maglev/git/rails.git.  That repository holds our
patches to rails and tracks the Rails GitHub repository.  See the readme in
/export/smalltalk/maglev/git for more details.

## Patchs

This section lists some patches and workarounds in effect for this code.

+ ActiveModel: Needs Psych#add_builtin_type

  I patched $MAGLEV_HOME/lib/ruby/1.8/psych/psych.rb to add a STUB version
  of Psych#add_builtin_type It does nothing, but so far, the rails stuff
  seems to work.  Aaron Patterson has assured me that he will eventualy get
  add_builtin_type implemeneted.

+ Bundler

  Requiring yaml in MRI will define to_yaml_properties on Object.  In
  Psych, to_yaml_properties is designed to be an override that is called,
  only if defined.  rails3 assumes to_yaml_properties is defined on Object,
  and so rails3 blows up with Psych.  Specifically, in
  bundler-0.9.13/lib/bundler/rubygems_ext.rb:

    alias :to_yaml_properties_before_crazy to_yaml_properties

  I've patched Object to define to_yaml_properties while working on rails.
  See the core_ext.rb file.

+ ActiveSupport: en.yml
  The en.yml file contains some syck specific additions: Use of ':' in
  front of a bare word to indicate a symbol:

     ---
     :foo     # Syck returns the symbol foo

  The YAML grammar does not allow an unquoted ':' in this manner.  So, I've
  changed the example to

     ---
     !ruby/sym foo

  Which works in both Syck and a (patched) Psych.  Psych does not yet
  support symbols, but it is a two line fix:

  --- a/lib/ruby/1.8/psych/psych/visitors/to_ruby.rb
  +++ b/lib/ruby/1.8/psych/psych/visitors/to_ruby.rb
  @@ -74,6 +74,8 @@ module Psych
             }
             args.push(args.delete_at(1) == '...')
             Range.new(*args)
  +        when /^!ruby\/sym(bol)?:?(.*)?$/
  +          o.value.to_sym
           else
             @ss.tokenize o.value
           end

+ Turn on -MallIvsDynamic

  There are a few places (e.g., application.rb) that create an instance of
  a class before the first closing of that class (i.e., before
  immediateInvariant has been called on the class).  That raises an
  exception. If you run with -MallIvsDynamic, then all instance variables
  will be dynamic, so we can send immediateInvariant before the closing of
  the class and thus allow instance creation.  The price is that everything
  runs slower.

  We could also wrap just specific classes with:

     Maglev::System.session_temp_put( :MAGLEV_allIvsDynamic, true )
     class X
       ...
     end
     Maglev::System.session_temp_put( :MAGLEV_allIvsDynamic, false )

  This is turned on in the Rakefile.

+ I needed to patch rack-1.0.0

[@cairo git (master)]$ diff -r /Users/pmclain/GemStone/checkouts/git/lib/maglev/gems/1.8.7/gems/rack-1.1.0 /opt/ruby/ruby/lib/ruby/gems/1.8/gems/rack-1.1.0/
Only in /opt/ruby/ruby/lib/ruby/gems/1.8/gems/rack-1.1.0/: .yardoc
diff -r /Users/pmclain/GemStone/checkouts/git/lib/maglev/gems/1.8.7/gems/rack-1.1.0/lib/rack/file.rb /opt/ruby/ruby/lib/ruby/gems/1.8/gems/rack-1.1.0/lib/rack/file.rb
32,42c32,33
<       r = @root
<       pi = @path_info
<       p = F.join(r, pi)
<       @path = p
< #      @path = F.join(@root, @path_info)
< #y = F
< #x = @path
< #puts "===== PATH: #{@path.inspect}"
< #puts "===== PATH: F.file? #{F.file?(@path)}"
< #puts "===== PATH: F.readable? #{F.readable?(@path)}"
< # nil.pause
---
>       @path = F.join(@root, @path_info)
>
69,70d59
< puts "===== serving: #{@path}"
<












commit 1667c9c817f756bcc213b09af9959bf4f52d0a42
Author: Peter McLain <peter.mclain@gemstone.com>
Date:   Fri Apr 30 13:12:25 2010 -0700

    Work around Trac 730: IO#readpartial is not implemented.

M       activesupport/lib/active_support/secure_random.rb

commit ca3bf6604a46648cd263e1c2bfef0c3529794fbf
Author: Peter McLain <peter.mclain@gemstone.com>
Date:   Fri Apr 30 10:59:39 2010 -0700

    Workaround a file not found problem.  Root cause TBD.

M       railties/lib/rails/application/finisher.rb

commit 487df5430d147e4fc6e14f2577cff4980a16cf24
Author: Peter McLain <peter.mclain@gemstone.com>
Date:   Fri Apr 30 10:59:15 2010 -0700

    Work around another issue removing a persistent method in transient mode.

M       activesupport/lib/active_support/dependencies.rb

commit 26a18edc4de872891f5a1ef964e1520ef17a61bd
Author: Peter McLain <peter.mclain@gemstone.com>
Date:   Fri Apr 30 10:52:27 2010 -0700

    Workaround MagLev's prohibition on aliasing to __send__.

M       activesupport/lib/active_support/core_ext/object/try.rb

commit 3e267c934365a7bf79762889dc89c739e33ec8ea
Author: Peter McLain <peter.mclain@gemstone.com>
Date:   Fri Apr 30 10:47:09 2010 -0700

    Provide MagLev implementation for finding subclasses through
    ObjectSpace#loaded_classes rather than ObjectSpace#each_object.

M       activesupport/lib/active_support/core_ext/class/subclasses.rb

commit 7c524e09424a1d9904219bc93668b0798c78ce20
Author: Peter McLain <peter.mclain@gemstone.com>
Date:   Fri Apr 30 10:40:56 2010 -0700

    Work around issue trying to remove_method on a persistent module while in
    transient mode.

M       activesupport/lib/active_support/core_ext/enumerable.rb

