task :default => :'app:run'

ENV['MAGLEV_OPTS'] = '-MnoRlwrap'

desc "Run tests on the application model"
task :test => :test_fixtures do
  test_files = Dir.glob('test/*_tests.rb')
  sh %{ ruby -Ilib -Itest #{test_files} }
end

# Commit the test fixture model code needed by tests into the Maglev server
task :test_fixtures do
  # TODO: should probably also run ../mdb/ rake commit
  puts "-- Loading test fixtures into maglev"
  sh %{ maglev-ruby -Itest test/mdb_fixtures.rb }
  puts "-- (done)"
end
# These tasks control the Sinatra application
namespace :app do
  desc "Run the client Sinatra app. Assumes rackup is in your path"
  task :run do
    #
    sh %{ rackup client.ru }
  end
end

# These tasks are used to manage the application's data in MDB; similar to
# Rails migrations.
namespace :mdb do
  # Or, should this be mdb:create[post.rb] ?
  desc "Create the databases on the MDB server."
  task :create do
    sh %{ maglev-ruby -Ilib migrations.rb }
  end
end
