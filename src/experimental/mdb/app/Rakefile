task :default => :'app:run'

ENV['MAGLEV_OPTS'] = '-MnoRlwrap'

# These tasks control the Sinatra application
namespace :app do
  desc "Run the client Sinatra app. Assumes rackup is in your path"
  task :run do
    sh %{ rackup client.ru }
  end
end


desc "Run all of the tests"
task :test => [ :'test:rest', :'test:app']
namespace :test do
  desc "Test the MDB::REST* wrappers."
  task :rest => :rest_fixtures do
    sh %{ ruby -Ilib -Itest -I../mdb/lib test/mdb_tests.rb }
  end

  # Commit the test fixture model code needed by tests into the Maglev server
  task :rest_fixtures do
    # TODO: should probably also run ../mdb/ rake commit
    puts "-- Loading test fixtures into maglev"
    sh %{ maglev-ruby -Itest test/mdb_fixtures.rb }
    puts "-- (done)"
  end

  desc "Run the application level tests"
  task :app do
    sh %{ maglev-ruby -Itest test/post_tests.rb }
  end
end

# These tasks are used to manage the application's data in MDB; similar to
# Rails migrations.
namespace :mdb do
  # Or, should this be mdb:create[post.rb] ?
  desc "Create the databases on the MDB server."
  task :create do
    sh %{ maglev-ruby -Ilib migrations.rb }
  end
end
