#!/bin/bash
#
# Runs the equivalent of "gemstone ruby" as a "maglev" command

# Make sure MAGLEV_HOME is set
if [ -z "${MAGLEV_HOME}" ]; then
    echo "\$MAGLEV_HOME is not set."
    echo "To fix this, set a valid MAGLEV_HOME in your .bashrc"
    exit 1
fi
# Make sure GEMSTONE is set
if [ -z "${GEMSTONE}" ]; then
    export GEMSTONE=$MAGLEV_HOME/gemstone
    # echo "Setting \$GEMSTONE to \$MAGLEV_HOME/gemstone"
fi
# Make sure the topaz command exists
if [ ! -x $GEMSTONE/bin/topaz ]; then
    echo "$GEMSTONE is not a valid GemStone product directory"
    echo "To fix this, set a valid GEMSTONE in your .bashrc"
    exit 1
fi
# Make sure we have one argument
if [ $# -ne 1 ]; then
    echo "The maglev command must have one argument"
    echo "i.e. maglev <filename>"
    exit 1
fi
# Make sure the argument is a valid file
if [ ! -e $1 ]; then
    echo "You executed \"maglev $*\""
    echo "The file \"$1\" does not exist"
    exit 1
fi

# Environment variable settings
export GEMSTONE_GLOBAL_DIR=$MAGLEV_HOME
export GEMSTONE_SYS_CONF=$MAGLEV_HOME/etc/system.conf
export TOPAZ_CMD="$GEMSTONE/bin/topaz -q -I $MAGLEV_HOME/etc/.topazini -l "
if [ -z "$JRUBY_PORT" ]; then
    export JRUBY_PORT=2000
fi

# run the maglev command
  FILE=$PWD/$1
  $TOPAZ_CMD <<ENDRUBY | sed -e '/^topaz 1> /s///' -e '/sz:0 cls:/s/\[.*\] //'
run
RubyContext load.
RubyContext loadFileNamed: '$FILE'.
%
exit
ENDRUBY

