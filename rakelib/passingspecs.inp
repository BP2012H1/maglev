output pushnew log/allspec.out
run
| specCount lf confFile specOutF oldDebug |
GsNMethod traceIR: false .
RubyContext load .
RubyContext requireFileNamed: 'mspec.rb' .

oldDebug := RubyContext default globals at: #DEBUG_SPEC .
RubyContext default globals at: #DEBUG_SPEC put: true .
RubyCompiler new evaluateString:
  '$formatter = DottedFormatter.new; $formatter.register'.
RubyContext save .
System commitTransaction ifFalse:[ nil error:'commit fail'].

specCount := 1 .
lf := Character lf .
confFile := GsFile openReadOnServer: '../gss64bit_3.0/tests/rubytst/passingspecs.conf' .
[ true ] whileTrue:[
  | aLine fullPath specResult |
  [
    aLine := confFile nextLine .
    aLine == nil ifTrue:[
      ^ specCount "hit eof"
    ].
    aLine first == $#
  ] whileTrue .
  aLine last == lf ifTrue:[ aLine size: (aLine size - 1) ].
  fullPath := '../rubyspec/1.8/' , aLine .
  GsFile gciLogServer:'--- start ', specCount asString , ': ' , aLine .
  System beginTransaction .
  RubyContext load .
  [
    specResult := RubyContext loadFileNamed: fullPath .
    GsFile gciLogServer: '--- end ' , aLine .
  ] on: Exception do: [:ex |
    GsFile gciLogServer: '<failed with error, ', ex asString, '>' .
    RubyContext default globals at: #DEBUG_SPEC put: oldDebug .
  ].
  specCount := specCount + 1 .
]
%
output pop
